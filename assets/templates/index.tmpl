<html>
{{template "public/header" .}}
<body>
<h2><a href="/">goFile</a></h2>
{{if .path}}
<p>{{t "cd"}}:{{.path}}</p>
{{end}}
{{if .prev}}
<a href="{{.prev}}">{{t "rl"}}</a>
{{end}}
{{$r := .reader}}
<ul>
    {{if .info.Dirs}}
    <h3>{{t "dls"}}</h3>
    {{$path := .path}}
    {{range $item := .info.Dirs}}
    <li class="c-b">
        <a href="/d/{{$path}}{{.DirName}}">{{$item.DirName}}</a>
        {{ if not $r }}
        <span class="f-r"><a onclick="rm({{.DirPath}})">{{t "del"}}</a></span>
        {{ end }}
    </li>
    {{end}}
    {{end}}
    {{if .info.Files}}
    <h3>{{t "fls"}}</h3>
    {{range $item := .info.Files}}
    <li class="c-b">
        <a target="_blank" href="/download/{{.FilePath}}">{{$item.FileName}}</a>
        <span class="f-r"><a target="_blank" href="/view/{{.FilePath}}">{{t "view"}}</a></span>
        {{ if not $r }}
        <span class="f-r"><a onclick="edite({{.FilePath}})">{{t "edit"}}</a></span>
        <span class="f-r"><a onclick="rm({{.FilePath}})">{{t "del"}}</a></span>
        {{if .IsZip}}
        <span class="f-r"><a onclick="unzip({{.FilePath}})">{{t "unzip"}}</a></span>
        {{end}}
        {{ end }}
    </li>
    {{end}}
    {{end}}
</ul>
{{ if not $r }}
<a href="#" onclick="createNewFile()">{{t "nFile"}}</a>
<a href="#" onclick="createNewDir()">{{t "nDir"}}</a>
<h3>{{t "cUpFile"}}</h3>
<form id="uploadForm" enctype="multipart/form-data">
    <input type="file" name="file" id="fileInput">
</form>
<div id="upload-progress" style="display:none;margin-top:10px;">
    <div style="font-size:13px;margin-bottom:4px;" id="upload-filename"></div>
    <div style="background:#ddd;border-radius:4px;height:16px;width:100%;overflow:hidden;">
        <div id="upload-bar" style="background:#337ab7;height:16px;width:0%;transition:width 0.15s;"></div>
    </div>
    <div style="font-size:12px;margin-top:4px;color:#555;" id="upload-percent">0%</div>
</div>
<script src="https://s3.pstatp.com/cdn/expire-1-M/jquery/3.2.1/jquery.min.js"></script>
<script>
    var CHUNK_SIZE = 2 * 1024 * 1024; // 2MB per chunk

    function getFileId(file) {
        return file.name + '_' + file.size + '_' + file.lastModified;
    }

    function showProgress(filename) {
        document.getElementById('upload-progress').style.display = 'block';
        document.getElementById('upload-filename').textContent = filename;
        updateProgress(0);
    }

    function updateProgress(percent) {
        var p = Math.min(100, Math.round(percent));
        document.getElementById('upload-bar').style.width = p + '%';
        document.getElementById('upload-percent').textContent = p + '%';
    }

    function hideProgress() {
        document.getElementById('upload-progress').style.display = 'none';
    }

    function checkChunks(fileId, totalChunks) {
        return fetch('/do/chunk/check', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'fileId=' + encodeURIComponent(fileId) + '&totalChunks=' + totalChunks
        }).then(function(r) { return r.json(); })
          .then(function(d) { return d.uploaded || []; })
          .catch(function() { return []; });
    }

    function uploadChunk(fileId, chunkIndex, totalChunks, chunk, onProgress) {
        return new Promise(function(resolve, reject) {
            var formData = new FormData();
            formData.append('fileId', fileId);
            formData.append('chunkIndex', chunkIndex);
            formData.append('totalChunks', totalChunks);
            formData.append('file', chunk);
            var xhr = new XMLHttpRequest();
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) onProgress(e.loaded / e.total);
            });
            xhr.onload = function() {
                try {
                    var data = JSON.parse(xhr.responseText);
                    data.stat ? resolve() : reject(new Error('chunk upload failed'));
                } catch(e) { reject(e); }
            };
            xhr.onerror = function() { reject(new Error('network error')); };
            xhr.open('POST', '/do/chunk/upload');
            xhr.send(formData);
        });
    }

    function mergeChunks(fileId, totalChunks, fileName, path) {
        return fetch('/do/chunk/merge', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'fileId=' + encodeURIComponent(fileId) +
                  '&totalChunks=' + totalChunks +
                  '&fileName=' + encodeURIComponent(fileName) +
                  '&path=' + encodeURIComponent(path)
        }).then(function(r) { return r.json(); })
          .then(function(d) { return d.stat; });
    }

    async function uploadFile(file, uploadPath) {
        var fileId = getFileId(file);
        var totalChunks = Math.ceil(file.size / CHUNK_SIZE) || 1;
        showProgress(file.name);

        var uploadedList = await checkChunks(fileId, totalChunks);
        var uploadedSet = new Set(uploadedList);
        var completedChunks = uploadedList.length;

        for (var i = 0; i < totalChunks; i++) {
            if (uploadedSet.has(i)) {
                updateProgress(completedChunks / totalChunks * 100);
                continue;
            }
            var chunk = file.slice(i * CHUNK_SIZE, Math.min((i + 1) * CHUNK_SIZE, file.size));
            var capturedI = i;
            try {
                await uploadChunk(fileId, capturedI, totalChunks, chunk, function(chunkProg) {
                    updateProgress((completedChunks + chunkProg) / totalChunks * 100);
                });
                completedChunks++;
                updateProgress(completedChunks / totalChunks * 100);
            } catch(e) {
                hideProgress();
                alert('上传失败：' + e.message);
                return;
            }
        }

        updateProgress(100);
        try {
            var ok = await mergeChunks(fileId, totalChunks, file.name, uploadPath);
            hideProgress();
            if (ok) {
                if (confirm('上传成功，点击确认刷新')) location.reload();
            } else {
                alert('文件合并失败');
            }
        } catch(e) {
            hideProgress();
            alert('合并请求失败');
        }
    }

    // 拖放上传
    var body = document.querySelector('body');
    body.addEventListener('drop', function(event) {
        event.preventDefault();
        event.stopPropagation();
        var file = event.dataTransfer.files[0];
        if (file) uploadFile(file, '{{.path}}');
    });
    body.addEventListener('dragover', function(event) {
        event.preventDefault();
        event.stopPropagation();
    });

    // 文件选择上传
    document.getElementById('fileInput').addEventListener('change', function() {
        if (this.files.length > 0) uploadFile(this.files[0], '{{.path}}');
    });

    function createNewDir() {
        var dirName = window.prompt("请输入文件夹名：");
        if (dirName !== null) {
            $.post("/do/newdir",{path:{{.path}},dirname:dirName},function(data,status){
                if(status == "success"){
                    if(data.stat){
                        if(confirm("操作成功，点击确认刷新")){
                            location.reload();
                        }}else{
                        alert("操作失败")
                    }
                }else{
                    alert('{{t "reqFail"}}');
                }
            });
        }
    }
    function createNewFile() {
        var fileName = window.prompt("请输入文件名：");
        if (fileName !== null) {
            $.post("/do/newfile",{path:{{.path}},filename:fileName},function(data,status){
                if(status == "success"){
                    if(data.stat){
                        if(confirm("操作成功，点击确认刷新")){
                            location.reload();
                        }}else{
                        alert("操作失败，可能文件已存在")
                    }
                }else{
                    alert('{{t "reqFail"}}');
                }
            });
        }
    }
    function unzip($path){
        if (confirm("你确定要解压"+$path+"吗？")){
            $.post("/do/unzip",{path:$path},function(data,status){
                if(status == "success"){
                    if(data.stat){
                        if(confirm("操作成功，点击确认刷新")){
                            location.reload();
                    }}else{
                        alert("操作失败")
                    }
                }else{
                    alert('{{t "reqFail"}}');
                }
            });
        }
    }
    function rm($path){
        if (confirm("你确定要删除"+$path+"吗？")){
            $.post("/do/rm",{path:$path},function(data,status){
                if(status == "success"){
                    if(data.stat){
                        if(confirm("操作成功，点击确认刷新")){
                            location.reload();
                        }}else{
                        alert("操作失败")
                    }
                }else{
                    alert('{{t "reqFail"}}');
                }
            });
        }
    }
    function edite(path) {
        var temp = document.createElement("form");
        temp.action = "/edite";
        temp.method = "post";
        temp.target = "_blank";
        temp.style.display = "none";
        var opt = document.createElement("input");
        opt.type = "text";
        opt.name = "path";
        opt.value = path;
        temp.appendChild(opt);
        document.body.appendChild(temp);
        temp.submit();
        return temp;
    }
</script>
{{ end }}
</body>
</html>
