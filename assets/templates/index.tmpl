<!DOCTYPE html>
<html lang="{{.htmlLang}}">
{{template "public/header" .}}
<body>
<div class="wrap">

  <!-- header -->
  <div class="hd">
    <a class="logo" href="/">goFile</a>
  </div>

  <!-- breadcrumb + back -->
  <div class="nav-row">
    <nav class="bc" id="bc"></nav>
    {{if .prev}}<a class="back" href="{{.prev}}">{{t "rl"}}</a>{{end}}
  </div>
  <script>
  (function(){
    var path = '{{.path}}';
    var bc = document.getElementById('bc');
    var html = '<a href="/">~</a>';
    if (path) {
      var parts = path.replace(/\/$/, '').split('/').filter(Boolean);
      var acc = '';
      for (var i = 0; i < parts.length; i++) {
        acc += encodeURIComponent(parts[i]) + '/';
        var isCur = i === parts.length - 1;
        var label = parts[i].replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        html += '<span class="bc-sep">/</span>';
        html += '<a' + (isCur ? ' class="bc-cur"' : '') + ' href="/d/' + acc + '">' + label + '</a>';
      }
    }
    bc.innerHTML = html;
  })();
  </script>

  {{if .diskTotal}}
  <div class="disk">
    <div class="disk-bar"><div class="disk-fill{{if gt .diskPct 85}} warn{{end}}" style="width:{{.diskPct}}%"></div></div>
    <span class="disk-text">{{.diskFree}} free · {{.diskTotal}}</span>
  </div>
  {{end}}

  {{$r := .reader}}

  <!-- directories -->
  {{if .info.Dirs}}
  <div class="label">{{t "dls"}}</div>
  <ul class="rows">
    {{$path := .path}}
    {{range .info.Dirs}}
    <li class="row">
      <span class="row-ico d">▸</span>
      <div class="row-name">
        <a href="/d/{{$path}}{{.DirName}}">{{.DirName}}</a>
      </div>
      {{if not $r}}
      <div class="row-acts">
        <a class="btn del" onclick="rm({{.DirPath}})">{{t "del"}}</a>
      </div>
      {{end}}
    </li>
    {{end}}
  </ul>
  {{end}}

  <!-- files -->
  {{if .info.Files}}
  <div class="label">{{t "fls"}}</div>
  <ul class="rows">
    {{range .info.Files}}
    <li class="row">
      <span class="row-ico">—</span>
      <div class="row-name">
        <a target="_blank" href="/download/{{.FilePath}}">{{.FileName}}</a>
        {{if .IsZip}}<span class="tag">zip</span>{{end}}
      </div>
      <div class="row-acts">
        <a class="btn" target="_blank" href="/view/{{.FilePath}}">{{t "view"}}</a>
        {{if not $r}}
        <a class="btn" onclick="edite({{.FilePath}})">{{t "edit"}}</a>
        {{if .IsZip}}
        <a class="btn" onclick="unzip({{.FilePath}})">{{t "unzip"}}</a>
        {{end}}
        <a class="btn del" onclick="rm({{.FilePath}})">{{t "del"}}</a>
        {{end}}
      </div>
    </li>
    {{end}}
  </ul>
  {{end}}

  {{if and (not .info.Dirs) (not .info.Files)}}
  <div class="empty">empty</div>
  {{end}}

  <!-- toolbar -->
  {{if not $r}}
  <div class="toolbar">
    <button class="tbtn" onclick="createNewFile()"><span class="pfx">+</span>{{t "nFile"}}</button>
    <button class="tbtn" onclick="createNewDir()"><span class="pfx">+</span>{{t "nDir"}}</button>
  </div>
  {{end}}

  <!-- upload -->
  {{if .allowUpload}}
  <div class="label up-section">{{t "cUpFile"}}</div>
  <div class="drop" id="dropZone">
    <p class="drop-hint">drop here · or <em>browse</em></p>
    <input type="file" id="fileInput">
  </div>
  <div class="prog" id="prog">
    <div class="prog-meta">
      <span id="prog-name"></span>
      <span id="prog-pct">0%</span>
    </div>
    <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
  </div>

  <div class="label">{{t "api"}}</div>
  <div class="api-box">
    <div class="api-meta">
      <span class="api-method">POST</span>
      <span class="api-endpoint" id="api-endpoint"></span>
    </div>
    <div class="api-code-wrap">
      <code class="api-code" id="api-code"></code>
      <button class="api-copy" id="api-copy-btn" onclick="copyApi()">{{t "copy"}}</button>
    </div>
  </div>

  <script src="https://s3.pstatp.com/cdn/expire-1-M/jquery/3.2.1/jquery.min.js"></script>
  <script>
    var CHUNK_SIZE = 2 * 1024 * 1024;

    function getFileId(f) { return f.name + '_' + f.size + '_' + f.lastModified; }

    function showProgress(name) {
      document.getElementById('prog').style.display = 'block';
      document.getElementById('prog-name').textContent = name;
      updateProgress(0);
    }
    function updateProgress(pct) {
      var p = Math.min(100, Math.round(pct));
      document.getElementById('prog-fill').style.width = p + '%';
      document.getElementById('prog-pct').textContent = p + '%';
    }
    function hideProgress() { document.getElementById('prog').style.display = 'none'; }

    function checkChunks(fileId, total) {
      return fetch('/do/chunk/check', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'fileId=' + encodeURIComponent(fileId) + '&totalChunks=' + total
      }).then(function(r){return r.json();}).then(function(d){return d.uploaded||[];}).catch(function(){return[];});
    }
    function uploadChunk(fileId, idx, total, chunk, onProg) {
      return new Promise(function(resolve, reject) {
        var fd = new FormData();
        fd.append('fileId', fileId); fd.append('chunkIndex', idx);
        fd.append('totalChunks', total); fd.append('file', chunk);
        var xhr = new XMLHttpRequest();
        xhr.upload.addEventListener('progress', function(e) { if (e.lengthComputable) onProg(e.loaded/e.total); });
        xhr.onload = function() {
          try { var d = JSON.parse(xhr.responseText); d.stat ? resolve() : reject(new Error('chunk failed')); }
          catch(e) { reject(e); }
        };
        xhr.onerror = function() { reject(new Error('network error')); };
        xhr.open('POST', '/do/chunk/upload');
        xhr.send(fd);
      });
    }
    function mergeChunks(fileId, total, name, path) {
      return fetch('/do/chunk/merge', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: 'fileId=' + encodeURIComponent(fileId) + '&totalChunks=' + total +
              '&fileName=' + encodeURIComponent(name) + '&path=' + encodeURIComponent(path)
      }).then(function(r){return r.json();}).then(function(d){return d.stat;});
    }

    async function uploadFile(file, uploadPath) {
      var fileId = getFileId(file);
      var total  = Math.ceil(file.size / CHUNK_SIZE) || 1;
      showProgress(file.name);
      var done = await checkChunks(fileId, total);
      var doneSet = new Set(done);
      var completed = done.length;
      for (var i = 0; i < total; i++) {
        if (doneSet.has(i)) { updateProgress(completed / total * 100); continue; }
        var chunk = file.slice(i * CHUNK_SIZE, Math.min((i+1) * CHUNK_SIZE, file.size));
        var ci = i;
        try {
          await uploadChunk(fileId, ci, total, chunk, function(p) {
            updateProgress((completed + p) / total * 100);
          });
          completed++;
          updateProgress(completed / total * 100);
        } catch(e) { hideProgress(); alert('{{t "upFile"}} {{t "fl"}}：' + e.message); return; }
      }
      updateProgress(100);
      try {
        var ok = await mergeChunks(fileId, total, file.name, uploadPath);
        hideProgress();
        if (ok) { if (confirm('{{t "upFile"}} {{t "sc"}}')) location.reload(); }
        else    { alert('{{t "upFile"}} {{t "fl"}}'); }
      } catch(e) { hideProgress(); alert('{{t "reqFail"}}'); }
    }

    var dz = document.getElementById('dropZone');
    document.body.addEventListener('dragover',  function(e) { e.preventDefault(); e.stopPropagation(); dz.classList.add('over'); });
    document.body.addEventListener('dragleave', function(e) { if (!dz.contains(e.relatedTarget)) dz.classList.remove('over'); });
    document.body.addEventListener('drop', function(e) {
      e.preventDefault(); e.stopPropagation(); dz.classList.remove('over');
      var f = e.dataTransfer.files[0];
      if (f) uploadFile(f, '{{.path}}');
    });
    document.getElementById('fileInput').addEventListener('change', function() {
      if (this.files.length > 0) uploadFile(this.files[0], '{{.path}}');
    });

    {{if not $r}}
    function createNewDir() {
      var n = window.prompt("{{t "nDir"}}:");
      if (n !== null) $.post("/do/newdir", {path:{{.path}}, dirname:n}, function(d,s) {
        if (s=="success") { if(d.stat) { if(confirm("OK")) location.reload(); } else alert("fail"); }
        else alert('{{t "reqFail"}}');
      });
    }
    function createNewFile() {
      var n = window.prompt("{{t "nFile"}}:");
      if (n !== null) $.post("/do/newfile", {path:{{.path}}, filename:n}, function(d,s) {
        if (s=="success") { if(d.stat) { if(confirm("OK")) location.reload(); } else alert("fail"); }
        else alert('{{t "reqFail"}}');
      });
    }
    function unzip(p) {
      if (confirm("unzip " + p + "?")) $.post("/do/unzip", {path:p}, function(d,s) {
        if (s=="success") { if(d.stat) { if(confirm("OK")) location.reload(); } else alert("fail"); }
        else alert('{{t "reqFail"}}');
      });
    }
    function rm(p) {
      if (confirm("delete " + p + "?")) $.post("/do/rm", {path:p}, function(d,s) {
        if (s=="success") { if(d.stat) { if(confirm("OK")) location.reload(); } else alert("fail"); }
        else alert('{{t "reqFail"}}');
      });
    }
    function edite(path) {
      var f = document.createElement("form");
      f.action="/edite"; f.method="post"; f.target="_blank"; f.style.display="none";
      var i = document.createElement("input"); i.type="text"; i.name="path"; i.value=path;
      f.appendChild(i); document.body.appendChild(f); f.submit();
    }
    {{end}}

    (function() {
      var origin = window.location.origin;
      var uploadPath = '{{.path}}';
      document.getElementById('api-endpoint').textContent = '/api/upload';
      document.getElementById('api-code').textContent =
        'curl -X POST ' + origin + '/api/upload \\\n' +
        '  -F "path=' + uploadPath + '" \\\n' +
        '  -F "file=@/path/to/file"';
    })();
    function copyApi() {
      var text = document.getElementById('api-code').textContent;
      var btn = document.getElementById('api-copy-btn');
      function done() {
        btn.textContent = '{{t "copied"}}'; btn.classList.add('ok');
        setTimeout(function() { btn.textContent = '{{t "copy"}}'; btn.classList.remove('ok'); }, 2000);
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(done).catch(function() {
          var ta = document.createElement('textarea'); ta.value = text;
          ta.style.position = 'fixed'; ta.style.opacity = '0';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy');
          document.body.removeChild(ta); done();
        });
      } else {
        var ta = document.createElement('textarea'); ta.value = text;
        ta.style.position = 'fixed'; ta.style.opacity = '0';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy');
        document.body.removeChild(ta); done();
      }
    }
  </script>
  {{end}}

</div>
</body>
</html>
